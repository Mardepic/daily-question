<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reflection Diary - Vuoden muistio</title>
  <style>
    body { font-family: Arial, sans-serif; background: #fdf6f0; color: #333; margin: 0; padding: 0; }
    header { text-align: center; padding: 1rem; background: #6b4226; color: white; }
    h1 { margin: 0; font-size: 1.8rem; }
    .container { max-width: 800px; margin: 2rem auto; padding: 1rem; }
    input, button, textarea { width: 100%; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; box-sizing: border-box; }
    button { background: #6b4226; color: white; border: none; cursor: pointer; }
    button:hover { background: #5a361e; }
    .day-card { background: #fff1e6; padding: 0.5rem; margin: 0.5rem 0; border-radius: 5px; }
    .day-title { font-weight: bold; margin-bottom: 0.3rem; }
    .question { font-style: italic; margin-bottom: 0.3rem; }
    #weekControls { display:flex; justify-content: space-between; margin:1rem 0; }
  </style>
</head>
<body>

  <header>
    <h1>Reflection Diary 2026</h1>
  </header>

  <div class="container">

    <!-- Login Section -->
    <div id="loginSection">
      <input type="email" id="email" placeholder="Sähköposti">
      <input type="password" id="password" placeholder="Salasana">
      <button id="loginBtn">Kirjaudu sisään</button>
      <button id="registerBtn">Rekisteröidy</button>
      <p id="loginStatus"></p>
    </div>

    <!-- Diary Section -->
    <div id="diarySection" style="display:none;">
      <div id="weekControls">
        <button id="prevWeekBtn">⬅ Edellinen viikko</button>
        <div id="weekNumber" style="font-weight:bold"></div>
        <button id="nextWeekBtn">Seuraava viikko ➡</button>
      </div>
      <div id="weekContainer"></div>
      <button id="logoutBtn">Kirjaudu ulos</button>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCJR7kIaO5R6b-mDigcaBUZbIv4lZhPd3g",
      authDomain: "reflection-diary-2026-d9b75.firebaseapp.com",
      projectId: "reflection-diary-2026-d9b75",
      storageBucket: "reflection-diary-2026-d9b75.firebasestorage.app",
      messagingSenderId: "40162654025",
      appId: "1:40162654025:web:49d152a55fced628f78c98",
      measurementId: "G-3RFHJPQV5Q"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginSection = document.getElementById("loginSection");
    const diarySection = document.getElementById("diarySection");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginStatus = document.getElementById("loginStatus");
    const weekContainer = document.getElementById("weekContainer");
    const weekNumberDiv = document.getElementById("weekNumber");
    const prevWeekBtn = document.getElementById("prevWeekBtn");
    const nextWeekBtn = document.getElementById("nextWeekBtn");

    let currentUser = null;
    const year = 2026;
    let currentWeek = 1;
    const days = ["Ma","Ti","Ke","To","Pe","La","Su"];

    // --- YEAR DATA --- koko vuoden kysymykset (esimerkki)
    const yearData = {
      "1": Array(31).fill("Mikä oli tämän päivän paras hetki?"),
      "2": Array(28).fill("Mikä sai sinut tänään hymyilemään?"),
      "3": Array(31).fill("Mitä opit tänään?"),
      "4": Array(30).fill("Mikä oli suurin haaste tänään?"),
      "5": Array(31).fill("Mikä sai sinut kiitolliseksi?"),
      "6": Array(30).fill("Mitä haluat parantaa huomenna?"),
      "7": Array(31).fill("Mikä teki sinusta ylpeän tänään?"),
      "8": Array(31).fill("Mikä oli päivän opetus?"),
      "9": Array(30).fill("Mitä haluat muistaa tästä päivästä?"),
      "10": Array(31).fill("Mitä sait valmiiksi tänään?"),
      "11": Array(30).fill("Mikä teki päivästä merkityksellisen?"),
      "12": Array(31).fill("Mikä oli päivän ilo?")
    };

    function getISOWeek(date) {
      const temp = new Date(date.valueOf());
      const dayNum = (date.getDay() + 6) % 7;
      temp.setDate(temp.getDate() - dayNum + 3);
      const firstThursday = new Date(temp.getFullYear(),0,4);
      return 1 + Math.round((temp - firstThursday) / 604800000);
    }

    function getDateOfISOWeek(week, year) {
      const simple = new Date(year, 0, 1 + (week - 1) * 7);
      const dow = simple.getDay();
      const ISOweekStart = simple;
      if (dow <= 4)
        ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
      else
        ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
      return ISOweekStart;
    }

    function formatDate(date) {
      return date.getDate() + "." + (date.getMonth()+1) + "." + date.getFullYear();
    }

    function getQuestionForDate(date) {
      const monthIndex = date.getMonth() + 1;
      const monthQuestions = yearData[monthIndex];
      return monthQuestions[(date.getDate()-1) % monthQuestions.length];
    }

    async function generateWeek(weekNumber) {
      weekContainer.innerHTML = "";
      const weekStart = getDateOfISOWeek(weekNumber, year);
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);

      weekNumberDiv.innerText = "Viikko " + weekNumber + " – " + formatDate(weekStart) + " – " + formatDate(weekEnd);

      for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(weekStart.getDate() + i);
        const question = getQuestionForDate(date);

        const key = year + "-" + date.toISOString().split("T")[0];
        let savedText = "";

        // Hae Firestoresta käyttäjäkohtainen vastaus
        try {
          const docRef = doc(db, "users", currentUser.uid, "weeks", key);
          const docSnap = await getDoc(docRef);
          if(docSnap.exists()) savedText = docSnap.data().answer || "";
        } catch(e) { console.error(e); }

        const card = document.createElement("div");
        card.className = "day-card";

        const textarea = document.createElement("textarea");
        textarea.rows = 4;
        textarea.placeholder = "Kirjoita ajatuksesi tähän...";
        textarea.value = savedText;

        textarea.addEventListener("change", async () => {
          try {
            await setDoc(doc(db, "users", currentUser.uid, "weeks", key), {
              answer: textarea.value,
              question: question,
              date: date.toISOString()
            });
          } catch(e) { console.error(e); }
        });

        card.innerHTML = `<div class="day-title">${days[i]} ${formatDate(date)}</div><div class="question">${question}</div>`;
        card.appendChild(textarea);
        weekContainer.appendChild(card);
      }
    }

    function nextWeek() { if(currentWeek<53){currentWeek++; generateWeek(currentWeek);} }
    function prevWeek() { if(currentWeek>1){currentWeek--; generateWeek(currentWeek);} }

    nextWeekBtn.addEventListener("click", ()=>nextWeek());
    prevWeekBtn.addEventListener("click", ()=>prevWeek());

    // --- Firebase Auth ---
    registerBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if(!email||!password){loginStatus.textContent="Täytä sähköposti ja salasana!"; return;}
      try { await createUserWithEmailAndPassword(auth, email, password); loginStatus.textContent="Rekisteröinti onnistui!"; } 
      catch(e){ loginStatus.textContent = "Virhe: "+e.message; }
    });

    loginBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      try { await signInWithEmailAndPassword(auth,email,password); } 
      catch(e){ loginStatus.textContent = "Virhe: "+e.message; }
    });

    logoutBtn.addEventListener("click", async()=>{ await signOut(auth); });

    onAuthStateChanged(auth, user => {
      if(user){ currentUser=user; loginSection.style.display="none"; diarySection.style.display="block"; generateWeek(currentWeek);}
      else{ currentUser=null; loginSection.style.display="block"; diarySection.style.display="none"; loginStatus.textContent=""; }
    });

  </script>
</body>
</html>
