<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reflection Diary 2026</title>
<style>
    body { font-family: sans-serif; padding: 20px; background:#f0f0f0; }
    #loginContainer, #diaryContainer { max-width: 800px; margin: auto; }
    .day-card { background:white; margin:10px 0; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    .day-title { font-weight:bold; margin-bottom:5px;}
    .question { margin-bottom:10px; font-style:italic;}
    textarea { width:100%; padding:8px; border-radius:10px; border:1px solid #ccc;}
    button { padding:8px 15px; border:none; border-radius:5px; margin:5px; cursor:pointer; }
</style>
</head>
<body>

<div id="loginContainer">
    <h2>Kirjaudu sisään</h2>
    <input type="email" id="email" placeholder="Sähköposti"><br><br>
    <input type="password" id="password" placeholder="Salasana"><br><br>
    <button id="registerBtn">Rekisteröidy</button>
    <button id="loginBtn">Kirjaudu sisään</button>
</div>

<div id="diaryContainer" style="display:none;">
    <h2 id="weekNumber"></h2>
    <div id="weekContainer"></div>
    <button onclick="prevWeek()">Edellinen viikko</button>
    <button onclick="nextWeek()">Seuraava viikko</button>
    <button onclick="logout()">Kirjaudu ulos</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

// --- Firebase Config ---
const firebaseConfig = {
    apiKey: "AIzaSyCJR7kIaO5R6b-mDigcaBUZbIv4lZhPd3g",
    authDomain: "reflection-diary-2026-d9b75.firebaseapp.com",
    projectId: "reflection-diary-2026-d9b75",
    storageBucket: "reflection-diary-2026-d9b75.firebasestorage.app",
    messagingSenderId: "40162654025",
    appId: "1:40162654025:web:49d152a55fced628f78c98",
    measurementId: "G-3RFHJPQV5Q"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const year = 2026;
let currentWeek = 1;
const days = ["Ma", "Ti", "Ke", "To", "Pe", "La", "Su"];

// --- Koko vuoden kysymykset (Tammikuu + Helmikuu esimerkki) ---
const questionsByMonth = {
    "Tammikuu": [
        "Mikä saa sinut tuntemaan itsesi eläväksi?",
        "Millainen haluaisit olla kymmenen vuoden päästä?",
        "Mikä on paras neuvo, jonka olet koskaan saanut?",
        "Mistä asiasta olet viimeksi muuttanut mielipidettäsi?",
        "Mikä lapsuusmuistosi on kirkkain?",
        "Millaista rakkautta haluat elämääsi?",
        "Mikä pelko estää sinua tällä hetkellä?"
    ],
    "Helmikuu": [
        "Kenelle haluaisit soittaa juuri nyt?",
        "Mikä on tärkein opetuksesi rakkaudesta?",
        "Miten osoitat välittämistäsi?",
        "Keneltä kaipaat anteeksiantoa?",
        "Millainen ystävä olet?",
        "Mikä on suurin väärinymmärryksesi ihmissuhteissasi?",
        "Kenelle haluaisit sanoa 'rakastan sinua'?"
    ]
    // Lisää muut kuukaudet samalla tavalla koko vuoden kysymyksillä
};

// --- Autentikointi ---
document.getElementById("registerBtn").addEventListener("click", async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
        await createUserWithEmailAndPassword(auth, email, password);
        alert("Rekisteröityminen onnistui!");
    } catch(e) { alert(e.message); }
});

document.getElementById("loginBtn").addEventListener("click", async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
        await signInWithEmailAndPassword(auth, email, password);
    } catch(e) { alert(e.message); }
});

function logout() { signOut(auth); }

onAuthStateChanged(auth, (user) => {
    if(user) {
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("diaryContainer").style.display = "block";
        generateWeek(currentWeek, user.uid);
    } else {
        document.getElementById("loginContainer").style.display = "block";
        document.getElementById("diaryContainer").style.display = "none";
    }
});

// --- Päivämäärä- ja viikkofunktiot ---
function getDateOfISOWeek(week, year) {
    const simple = new Date(year, 0, 1 + (week - 1) * 7);
    const dow = simple.getDay();
    const ISOweekStart = simple;
    if (dow <= 4)
        ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
    else
        ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
    return ISOweekStart;
}

function formatDate(date) {
    return date.getDate() + "." + (date.getMonth()+1) + "." + date.getFullYear();
}

// --- Viikon generointi ---
async function generateWeek(weekNumber, uid) {
    const container = document.getElementById("weekContainer");
    const weekNumberDiv = document.getElementById("weekNumber");

    const weekStart = getDateOfISOWeek(weekNumber, year);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);

    weekNumberDiv.innerText =
        "Viikko " + weekNumber + " – " +
        formatDate(weekStart) + " – " +
        formatDate(weekEnd);

    container.innerHTML = "";

    for(let i=0; i<7; i++) {
        const date = new Date(weekStart);
        date.setDate(weekStart.getDate() + i);

        // Kuukauden nimi
        const monthIndex = date.getMonth();
        const monthNames = Object.keys(questionsByMonth);
        const monthName = monthNames[monthIndex] || monthNames[0];
        const questions = questionsByMonth[monthName];
        const question = questions[i % questions.length];

        const key = year + "-" + date.toISOString().split("T")[0];

        // Hae tallennettu vastaus Firestoresta
        const docRef = doc(db, "diaries", uid + "_" + key);
        let savedText = "";
        try {
            const docSnap = await getDoc(docRef);
            if(docSnap.exists()) savedText = docSnap.data().answer || "";
        } catch(e){ console.log(e); }

        const card = document.createElement("div");
        card.className = "day-card";
        card.innerHTML = `
            <div class="day-title">${days[i]} ${formatDate(date)}</div>
            <div class="question">${question}</div>
            <textarea rows="4" placeholder="Kirjoita ajatuksesi tähän...">${savedText}</textarea>
        `;
        const textarea = card.querySelector("textarea");
        textarea.addEventListener("change", async () => {
            try {
                await setDoc(doc(db, "diaries", uid + "_" + key), { answer: textarea.value });
            } catch(e){ console.log(e); }
        });

        container.appendChild(card);
    }
}

function nextWeek(){ if(currentWeek<53){ currentWeek++; generateWeek(currentWeek, auth.currentUser.uid); }}
function prevWeek(){ if(currentWeek>1){ currentWeek--; generateWeek(currentWeek, auth.currentUser.uid); }}

</script>
</body>
</html>
