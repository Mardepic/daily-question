<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kysymys sinulle</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@1,400&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Georgia,serif;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);min-height:100vh;padding:20px;color:#2c3e50}
#loginContainer{max-width:400px;margin:100px auto;background:#fff;padding:40px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.1)}
#loginContainer h2{text-align:center;margin-bottom:30px;color:#34495e;font-size:28px}
#loginContainer input{width:100%;padding:12px;margin-bottom:15px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;transition:border-color .3s}
#loginContainer input:focus{outline:0;border-color:#3498db}
#diaryContainer{max-width:1200px;margin:0 auto}
.diary-header{text-align:center;margin-bottom:40px;background:#fff;padding:30px;border-radius:20px;box-shadow:0 5px 20px rgba(0,0,0,.08)}
.diary-header h1{font-size:36px;color:#2c3e50;margin-bottom:10px;font-weight:400;letter-spacing:1px}
#weekNumber{font-size:20px;color:#7f8c8d;font-weight:300}
#weekContainer{display:grid;grid-template-columns:1fr;gap:20px;margin-bottom:30px}
.day-card{background:#fff;padding:30px;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,.08);transition:transform .2s,box-shadow .2s;border-left:5px solid #3498db}
.day-card:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,.12)}
.day-card:nth-child(1){border-left-color:#e74c3c}
.day-card:nth-child(2){border-left-color:#f39c12}
.day-card:nth-child(3){border-left-color:#f1c40f}
.day-card:nth-child(4){border-left-color:#2ecc71}
.day-card:nth-child(5){border-left-color:#3498db}
.day-card:nth-child(6){border-left-color:#9b59b6}
.day-card:nth-child(7){border-left-color:#e91e63}
.day-title{font-size:28px;font-weight:600;color:#2c3e50;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #ecf0f1}
.question{font-family:Nunito,sans-serif;font-size:18px;color:#34495e;margin-bottom:20px;font-style:italic;line-height:1.6;padding:15px;background:#f8f9fa;border-radius:10px;border-left:3px solid #3498db}
textarea{width:100%;padding:15px;border:2px solid #e0e0e0;border-radius:10px;font-family:Georgia,serif;font-size:16px;line-height:1.8;resize:vertical;min-height:120px;transition:border-color .3s}
textarea:focus{outline:0;border-color:#3498db;background:#fafbfc}
.navigation{display:flex;justify-content:center;gap:15px;margin-bottom:20px}
button{padding:12px 25px;border:0;border-radius:10px;font-size:16px;cursor:pointer;transition:all .3s;font-family:Arial,sans-serif;font-weight:500}
button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
#loginContainer button{width:100%;background:#3498db;color:#fff;margin-top:10px}
#loginContainer button:hover{background:#2980b9}
.nav-button{background:#3498db;color:#fff}
.nav-button:hover{background:#2980b9}
.nav-button:disabled{background:#95a5a6;cursor:not-allowed;transform:none}
.logout-button{background:#e74c3c;color:#fff}
.logout-button:hover{background:#c0392b}
@media (max-width:768px){
.diary-header h1{font-size:28px}
.day-card{padding:20px}
.day-title{font-size:22px}
.navigation{flex-direction:column}
button{width:100%}
}
</style>
</head>
<body>

<div id="loginContainer">
    <h2>‚ú® Kysymys sinulle</h2>
    <input type="email" id="email" placeholder="S√§hk√∂posti">
    <input type="password" id="password" placeholder="Salasana">
    <button id="registerBtn">Rekister√∂idy</button>
    <button id="loginBtn">Kirjaudu sis√§√§n</button>
</div>

<div id="diaryContainer" style="display:none;">
    <div class="diary-header">
        <h1>üìñ Kysymys sinulle</h1>
        <div id="weekNumber"></div>
    </div>
    
    <div id="weekContainer"></div>
    
    <div class="navigation">
        <button class="nav-button" onclick="prevWeek()">‚Üê Edellinen viikko</button>
        <button class="nav-button" onclick="nextWeek()">Seuraava viikko ‚Üí</button>
    </div>
    
    <div class="navigation">
        <button class="logout-button" onclick="logout()">Kirjaudu ulos</button>
    </div>
</div>

<script src="questions.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

// --- Firebase Config ---
const firebaseConfig = {
    apiKey: "AIzaSyCJR7kIaO5R6b-mDigcaBUZbIv4lZhPd3g",
    authDomain: "reflection-diary-2026-d9b75.firebaseapp.com",
    projectId: "reflection-diary-2026-d9b75",
    storageBucket: "reflection-diary-2026-d9b75.firebasestorage.app",
    messagingSenderId: "40162654025",
    appId: "1:40162654025:web:49d152a55fced628f78c98",
    measurementId: "G-3RFHJPQV5Q"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const year = 2026;
let currentWeek = 1;
const days = ["Maanantai", "Tiistai", "Keskiviikko", "Torstai", "Perjantai", "Lauantai", "Sunnuntai"];

// Funktio joka palauttaa kysymyksen p√§iv√§n numeron perusteella (1-365)
function getQuestion(dayOfYear) {
    return QUESTIONS[dayOfYear] || "Mit√§ ajattelet t√§n√§√§n?";
}

// --- Autentikointi ---
document.getElementById("registerBtn").addEventListener("click", async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
        await createUserWithEmailAndPassword(auth, email, password);
        alert("Rekister√∂ityminen onnistui!");
    } catch(e) { alert(e.message); }
});

document.getElementById("loginBtn").addEventListener("click", async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
        await signInWithEmailAndPassword(auth, email, password);
    } catch(e) { alert(e.message); }
});

window.logout = function() { signOut(auth); }

onAuthStateChanged(auth, (user) => {
    if(user) {
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("diaryContainer").style.display = "block";
        generateWeek(currentWeek, user.uid);
    } else {
        document.getElementById("loginContainer").style.display = "block";
        document.getElementById("diaryContainer").style.display = "none";
    }
});

// --- P√§iv√§m√§√§r√§- ja viikkofunktiot ---
function getDateOfISOWeek(week, year) {
    const simple = new Date(year, 0, 1 + (week - 1) * 7);
    const dow = simple.getDay();
    const ISOweekStart = simple;
    if (dow <= 4)
        ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
    else
        ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
    return ISOweekStart;
}

function getDayOfYear(date) {
    const start = new Date(date.getFullYear(), 0, 0);
    const diff = date - start;
    const oneDay = 1000 * 60 * 60 * 24;
    return Math.floor(diff / oneDay);
}

// --- Viikon generointi ---
async function generateWeek(weekNumber, uid) {
    const container = document.getElementById("weekContainer");
    const weekNumberDiv = document.getElementById("weekNumber");

    const weekStart = getDateOfISOWeek(weekNumber, year);

    weekNumberDiv.innerText = "Viikko " + weekNumber;

    container.innerHTML = "";

    // Debounce funktio tallennukselle
    let saveTimers = {};
    
    for(let i=0; i<7; i++) {
        const date = new Date(weekStart);
        date.setDate(weekStart.getDate() + i);

        const dayOfYear = getDayOfYear(date);
        const question = getQuestion(dayOfYear);
        const key = year + "-" + date.toISOString().split("T")[0];

        // Hae tallennettu vastaus Firestoresta
        const docRef = doc(db, "diaries", uid + "_" + key);
        let savedText = "";
        try {
            const docSnap = await getDoc(docRef);
            if(docSnap.exists()) savedText = docSnap.data().answer || "";
        } catch(e){ console.log(e); }

        const card = document.createElement("div");
        card.className = "day-card";
        card.innerHTML = `
            <div class="day-title">${days[i]}</div>
            <div class="question">${question}</div>
            <textarea rows="4" placeholder="Kirjoita ajatuksesi t√§h√§n...">${savedText}</textarea>
        `;
        
        const textarea = card.querySelector("textarea");
        
        // Debounced save - odottaa 1 sekuntin ennen tallennusta
        textarea.addEventListener("input", () => {
            clearTimeout(saveTimers[key]);
            saveTimers[key] = setTimeout(async () => {
                try {
                    await setDoc(doc(db, "diaries", uid + "_" + key), { answer: textarea.value });
                } catch(e){ console.log(e); }
            }, 1000);
        });

        container.appendChild(card);
    }
}

window.nextWeek = function(){ 
    if(currentWeek<53){ 
        currentWeek++; 
        generateWeek(currentWeek, auth.currentUser.uid); 
    }
}

window.prevWeek = function(){ 
    if(currentWeek>1){ 
        currentWeek--; 
        generateWeek(currentWeek, auth.currentUser.uid); 
    }
}

</script>
</body>
</html>
